<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.11/semantic.css" />
    <style type="text/css">
      body > .ui.container { margin-top: 3em; }
      i.leaf.icon.greenicon { color: #339933; }
      span#latest.greenstatus { color: #009933; }
      span#latest.redstatus { color: #cc3300; }
      .hiddenf { display: none; }
    </style>
    <title>Wissen</title>
  </head>
  <body>
    <th:block th:include="${menuSource} :: ${menuFragment}"> </th:block>
    <th:block th:include="${contentSource} :: ${contentFragment}"></th:block>
    
    <div class="ui modal" id="authmod">
      <i class="close icon"></i>
      <div class="header">Authentication stage</div>
      
      <div class="content">
        <div class="ui icon message">
          <i class="id badge icon"></i>
          <div class="content">
            <div class="header">Hi! Stranger</div>
            <p>
              We have noticed that you are not logged in. This
              can be an issue if you try to access some areas 
              of the site that are not allowed to unidentified 
              users. So in order to continue, please log in.
              <i class="smile icon"></i>
            </p>
          </div>
        </div>
        <div class="ui hidden negative message" id="wrongcredentials">
          <i class="close icon"></i>
          <div class="header">
            Wrong credentials
          </div>
        </div>
        <form class="ui form">
          <div class="field">
            <label>User</label>
            <input type="text" id="user" name="user" placeholder="User" />
          </div>
          <div class="field">
            <label>Password</label>
            <input type="password" id="passwd" name="passwd" placeholder="Password" />
          </div>
          <div class="center aligned">
            <button class="ui button" type="button" onclick="authenticate()">Submit</button>
          </div>
        </form>
      </div>
    </div>
    
    <div class="ui modal" id="newtaskmod">
      <i class="close icon"></i>
      <div class="header">New Task</div>
      <div class="scrolling content">
        <form class="ui form">
          <div class="field">
            <label>Title</label>
            <input type="text" name="tasktitlef" placeholder="Some task name" />
          </div>
          <div class="field">
            <div class="ui checkbox">
              <input type="checkbox" name="taskdescneededf" onchange="toggleNewTaskDesc()" checked="true" />
              <label>Description needed?</label>
            </div>
          </div>
          <div class="field" id="taskdescfieldf">
            <label>Description</label>
            <textarea rows="3" name="taskdescf"></textarea>
          </div>
          <div class="field">
            <label>Due date</label>
            <input type="datetime-local" name="taskduedatef" />
          </div>
          <div class="field">
            <div class="ui checkbox">
              <input type="checkbox" name="taskexpiresf" onchange="toggleExpireDate()" checked="true"/>
              <label>Expires?</label>
            </div>
          </div>
          <div class="field" id="taskexpirationdatefieldf">
            <label>Expiration date</label>
            <input type="datetime-local" name="taskexpirationdatef" />
          </div>
          <div class="right aligned">
            <button class="ui button" type="button">Create task</button>
          </div>
        </form>
      </div>
    </div>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.11/semantic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <script src="/js/wissen.js"></script>
    <script>
      $('.ui.dropdown').dropdown();
      $('.ui.modal').modal();
      $('.progress').progress();
      $('.message .close').on('click', function() {
        $(this).closest('.message').transition('fade');
      });
      
      //<![CDATA[
      if($.cookie("authuser") != undefined && $.cookie("authtoken") != undefined) {
        $.ajax({
          type: 'GET',
          url: "/oauth/check_token?token=" + $.cookie("authtoken"),
          headers: {
            "Authorization" : "Basic bWFzdGVyOjEyMzQ1Ng==",
            "Accept" : "application/json"
          },
          success: function(response) {
            $("#authuser").text(response.user_name);
          },
          error: function(XMLHttpRequest) {
            if(XMLHttpRequest.status == 400) {
              $.removeCookie("authuser");
              $.removeCookie("authtoken");
              $("#authuser").text("Anonymous");
            }
          }
        });
      }
      //]]>
      
      $.ajax({
        type: 'GET',
        url: "/api/irrigationRecords/search/findTop1ByOrderByDateDesc",
        contentType: "application/json; charset=utf-8",
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          console.log(textStatus);
          console.log(XMLHttpRequest);
          $("#latest").text("no data available");
          $("#latest").addClass("redstatus");
        },
        success: function(resultData) {
          var x = document.getElementById("latest");
          if(x != null){
            if(resultData != null){
              var lDate = new Date(resultData.date);
              var cDate = new Date();
              var diff = (cDate.getTime()-lDate.getTime())/1000/60/60;
              
              $("#latest").text(parseFloat(diff).toFixed(2) + " hours ago");
              if(diff > 48){
                $("#latest").addClass("redstatus");
              }
              else {
                $("#latest").addClass("greenstatus");
              }
            }
            else {
              $("#latest").text("no data available");
              $("#latest").addClass("redstatus");
            }
          }
        }
      });
    </script>
  </body>
</html>